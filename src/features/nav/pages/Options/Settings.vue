<template>
  <v-container>
    <h3 class="heading text-accent">User Options</h3>
    <v-row density="compact">
      <v-col md="12" lg="6" class="mr-3">
        <div class="flavor-text">
          <b>USER ID:</b>
          <span class="text-accent">
            {{ userID }}
          </span>
        </div>
        <v-divider />
        <div class="text-center">
          <div>
            <v-btn large block color="info" class="my-1" @click="reload">
              Download Updates and Reload
            </v-btn>
            <v-btn block color="accent" class="my-1" @click="showMessage()">
              Show Latest Update Message
            </v-btn>
            <v-divider class="my-2" />
          </div>
          <div class="text-center my-2">
            <v-btn block large color="primary" @click="bulkExport">
              <v-icon start>mdi-database</v-icon>
              Create Data Backup
              <cc-tooltip
                inline
                content="COMP/CON relies on your browser to save and load its data. Settings, utilities, and other applications can erase your browser's localStorage cache, resulting in the loss of your COMP/CON data. IT is <b>strongly</b> recommended to back up your data often."
              >
                <v-icon end class="fade-select">mdi-help-circle-outline</v-icon>
              </cc-tooltip>
            </v-btn>
          </div>
          <div class="text-center my-2">
            <v-dialog v-model="importDialog" width="50%">
              <template #activator="{ props }">
                <v-btn block large color="primary" v-bind="props">
                  <v-icon start>mdi-database-refresh</v-icon>
                  Load Data Backup
                  <cc-tooltip
                    inline
                    content="COMP/CON relies on your browser to save and load its data. Settings, utilities, and other applications can erase your browser's localStorage cache, resulting in the loss of your COMP/CON data. IT is <b>strongly</b> recommended to back up your data often."
                  >
                    <v-icon end class="fade-select">mdi-help-circle-outline</v-icon>
                  </cc-tooltip>
                </v-btn>
              </template>
              <v-card>
                <v-card-text class="pa-6">
                  <p class="text-center heading h3 text-text">
                    This will OVERWRITE
                    <b class="text-accent">ALL</b>
                    local COMP/CON data.
                    <br />
                    This
                    <b class="text-accent">cannot</b>
                    be undone.
                  </p>
                  <v-file-input
                    v-model="fileValue"
                    accept=".compcon"
                    variant="outlined"
                    density="compact"
                    hide-details
                    autofocus
                    placeholder="Select COMP/CON Bulk Export File"
                    prepend-icon="mdi-paperclip"
                    @change="bulkImport"
                  />
                </v-card-text>
              </v-card>
            </v-dialog>
          </div>
        </div>
      </v-col>
      <v-col>
        <h3 class="heading text-accent mb-n2">Advanced Options</h3>
        <v-switch v-model="userViewExotics" color="exotic" inset density="compact" hide-details>
          <template #label>
            Show Exotic items in the Compendium
            <cc-tooltip
              title="SPOILER ALERT"
              content="Enabling this option may reveal campaign spoilers and it is recommended to leave this setting DISABLED
              if you are not the GM"
              inline
            >
              <v-icon color="warning">mdi-alert</v-icon>
            </cc-tooltip>
          </template>
        </v-switch>
        <v-switch v-model="userAllowQuickstart" color="exotic" inset density="compact" hide-details>
          <template #label>Enable quick pilot creation and level-up</template>
        </v-switch>
        <h3 class="heading text-accent mt-2">Theme</h3>
        <v-select
          v-model="theme"
          density="compact"
          variant="outlined"
          :items="themes"
          item-text="name"
        />
      </v-col>
    </v-row>

    <v-divider class="my-4" />

    <h3 class="heading text-accent">Achievements</h3>
    <p class="panel py-3 text-center text-subtle">
      <v-icon color="grey">mdi-lock</v-icon>
      <br />
      // FEATURE IN DEVELOPMENT //
    </p>

    <div class="text-right">
      <router-link to="./ui-test">
        <v-btn small text>UI Test</v-btn>
      </router-link>
    </div>
  </v-container>
</template>

<script lang="ts">
import * as allThemes from '@/ui/style/themes';

import { UserStore } from '@/stores';
import { exportAll, importAll, clearAllData } from '@/io/BulkData';
import { saveFile } from '@/io/Dialog';
import DeletedItems from './DeletedItems.vue';
import { SetTheme } from '@/classes/utility/ThemeManager';

export default {
  name: 'options-settings',
  components: { DeletedItems },
  data: () => ({
    themes: [] as { name: string; value: string }[],
    importDialog: false,
    fileValue: null,
    deleteDialog: false,
  }),
  computed: {
    user() {
      const store = UserStore();
      return store.UserProfile;
    },
    userViewExotics: {
      get: function () {
        return this.user.Option('showExotics');
      },
      set: function (newval) {
        this.user.SetView('showExotics', newval);
      },
    },
    userAllowQuickstart: {
      get: function () {
        return this.user.Option('quickstart');
      },
      set: function (newval) {
        this.user.SetView('quickstart', newval);
      },
    },
    theme: {
      get: function () {
        return this.user.Theme;
      },
      set: function (newval) {
        this.user.Theme = newval;
        SetTheme(this.theme, this.$vuetify);
      },
    },
    userID() {
      return this.user.ID;
    },
    userTheme() {
      return this.user.Theme;
    },
  },
  created() {
    for (const k in allThemes) {
      const e = allThemes[k];
      this.themes.push({ name: e.name, value: e.id });
    }
  },
  methods: {
    reload() {
      location.reload();
    },
    showMessage() {
      const store = UserStore();
      store.UserProfile.WelcomeHash = '';
      localStorage.removeItem('cc-welcome-hash');
      this.reload();
    },
    async bulkExport() {
      const result = await exportAll();
      await saveFile(
        `CC_${new Date().toISOString().slice(0, 10)}.compcon`,
        JSON.stringify(result),
        'Save COMP/CON Archive'
      );
    },
    async bulkImport(file) {
      await importAll(file)
        .then(() =>
          this.$notify({
            title: 'Data import successful',
            text: `Local user data has been overwritten.`,
            data: { icon: 'mdi-database-arrow-left-outline' },
          })
        )
        .catch((err) =>
          this.$notify({
            title: 'Unable to import data',
            text: `ERROR: ${err}`,
            data: { color: 'error', icon: 'mdi-database-off-outline' },
          })
        );
      this.importDialog = false;
    },
    async deleteAll() {
      await clearAllData(false);
      this.deleteDialog = false;
    },
  },
};
</script>
