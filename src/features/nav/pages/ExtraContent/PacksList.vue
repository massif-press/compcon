<template>
  <div class="packsList">
    <v-data-table
      hide-default-footer
      disable-pagination
      no-data-text="No content packs installed."
      :headers="headers"
      :items="contentPacks"
      show-expand
      item-key="Key"
    >
      <!-- Active toggle -->
      <template #[`item.toggleActive`]="{ item }">
        <v-switch
          :input-value="item.Active"
          color="primary"
          @change="toggleActive(item.ID, $event)"
        />
      </template>
      <!-- Name -->
      <template #[`item.Name`]="{ item }">
        <span class="heading h3" :class="item.Active ? 'text-accent' : 'text-subtle font-italic'">
          {{ item.Name }}
        </span>
      </template>
      <!-- Version -->
      <template #[`item.Version`]="{ item }">
        <span class="packVersion">
          {{ item.Version }}
        </span>
      </template>
      <!-- Delete action -->
      <template #[`item.deleteAction`]="{ item }">
        <v-menu offset-y offset-x top nudge-left="30px">
          <template #activator="{ props }">
            <v-btn icon color="primary" class="fade-select" v-bind="props">
              <v-icon icon="delete" />
            </v-btn>
          </template>
          <v-card>
            <v-card-text class="text-center body-text">
              <p>
                This will remove this pack and all of its contents from COMP/CON. User data that
                relies on this content will be unavailable and may cause errors. Are you sure you
                want to continue?
              </p>
              <v-divider class="my-2" />
              <v-row density="compact">
                <v-btn small text>CANCEL</v-btn>
                <v-btn small color="error" class="ml-auto" @click="deletePack(item.ID)">
                  CONFIRM
                </v-btn>
              </v-row>
            </v-card-text>
          </v-card>
        </v-menu>
      </template>
      <!-- Expanded view -->
      <template #expanded-item="{ item, headers }">
        <td :colspan="headers.length" class="py-4 px-6 w-100 light-panel">
          <v-row>
            <v-col>
              <p class="body-text text-text pa-2 mb-1">
                <span v-if="item.Description">
                  {{ item.Description }}
                </span>
                <span v-else>No description given.</span>
              </p>

              <div v-if="item.Website" class="mt-2">
                <v-divider class="ma-1" />
                <v-btn target="_blank" :href="item.Website" text color="secondary">
                  <v-icon prepend class="mr-1">open_in_new</v-icon>
                  &nbsp;Website
                </v-btn>
              </div>
            </v-col>
            <v-col cols="2">
              <v-img :src="item.ImageURL" alt="Pack image" max-width="200px" max-height="300px" />
            </v-col>
          </v-row>
        </td>
      </template>
    </v-data-table>
  </div>
</template>

<script lang="ts">
import { CompendiumStore, PilotStore, NpcStore } from '@/stores';

import { ContentPack } from '@/class';

export default {
  name: 'PacksList',
  data: () => ({
    expanded: [],
    headers: [
      { title: 'Active', value: 'toggleActive', sortable: false },
      { title: 'Name', value: 'Name' },
      { title: 'Author', value: 'Author' },
      { title: 'Version', value: 'Version' },
      { title: '', value: 'deleteAction', sortable: false },
    ],
  }),
  computed: {
    contentPacks(): ContentPack[] {
      // return this.CompendiumStore().ContentPacks;
    },
    compendiumStore(): CompendiumStore {
      return CompendiumStore();
    },
  },
  methods: {
    async toggleActive(packID: string, active: boolean): Promise<void> {
      await this.CompendiumStore().setPackActive({
        packID,
        active,
      });
      await this.reload();
    },
    async deletePack(id: string): Promise<void> {
      await this.CompendiumStore().deleteContentPack(id);
      await this.reload();
    },
    async reload() {
      // this.$emit('start-load');
      // const pilotStore =PilotStore();
      // const npcStore =NpcStore();
      // const missing = { pilots: [], npcs: [] };
      // await pilotStore.loadPilots();
      // missing.pilots = pilotStore.MissingPilots;
      // await npcStore.loadNpcs();
      // missing.npcs = npcStore.MissingNpcs;
      // await this.CompendiumStore().setMissingContent(missing);
      // this.$emit('end-load');
    },
  },
};
</script>

<style scoped>
.packsList :deep(.v-data-table tbody tr.v-data-table__expanded__content) {
  box-shadow: none;
}
</style>
