<template>
  <div>
    <v-row align="start" class="mb-n3">
      <v-col>
        <span class="heading mech" style="line-height: 5px">{{ pilot.Callsign }}</span>
        <div class="flavor-text text-subtle">{{ pilot.Name }}</div>
      </v-col>
      <v-col cols="auto" class="ml-auto text-right mr-2 mt-n2">
        <div class="heading h3 text-accent">HP</div>
        <div class="font-weight-bold mr-n5">
          <v-btn icon x-small class="fade-select" @click="pilot.CurrentHP -= 1">
            <v-icon small color="primary">mdi-minus</v-icon>
          </v-btn>
          {{ pilot.CurrentHP }}/{{ pilot.MaxHP }}
          <v-btn icon x-small class="fade-select" @click="pilot.CurrentHP += 1">
            <v-icon small color="primary">mdi-plus</v-icon>
          </v-btn>
        </div>
      </v-col>
      <v-col cols="auto" class="text-right mx-2 mt-n2">
        <div class="heading h3 text-accent">Armor</div>
        <div class="font-weight-bold">{{ pilot.Armor }}</div>
      </v-col>
      <v-col cols="auto" class="text-right mx-2 mt-n2">
        <div class="heading h3 text-accent">E-Defense</div>
        <div class="font-weight-bold">{{ pilot.EDefense }}</div>
      </v-col>
      <v-col cols="auto" class="text-right mx-2 mt-n2">
        <div class="heading h3 text-accent">Evasion</div>
        <div class="font-weight-bold">{{ pilot.Evasion }}</div>
      </v-col>
      <v-col cols="auto" class="text-right mx-2 mt-n2">
        <div class="heading h3 text-accent">Grit</div>
        <div class="font-weight-bold">+{{ pilot.Grit }}</div>
      </v-col>
    </v-row>

    <div v-if="mech.Destroyed || mech.ReactorDestroyed">
      <v-row v-if="mech.Destroyed" density="compact" justify="center" class="text-center mb-n5">
        <v-col cols="auto">
          <v-alert density="compact" variant="outlined" color="error" prominent>
            <v-icon slot="prepend" color="error" size="70" class="mr-3">cc:eclipse</v-icon>
            <span class="heading h1">MECH DESTROYED</span>
            <div class="heading mt-n4 text-subtle">FRAME.CRITICAL//: CATASTROPHIC DAMAGE</div>
          </v-alert>
        </v-col>
      </v-row>
      <div v-if="mech.ReactorDestroyed">
        <p class="heading h2 text-stark text-center pt-4">
          This mech cannot be repaired and must be reprinted.
        </p>
      </div>
      <div v-else class="ma-3 panel clipped pt-3 px-6 text-center">
        <v-alert color="warning" variant="outlined" border="bottom" class="mb-2">
          <div class="body-text text-text">
            This mech can be repaired to working order by spending
            <b class="text-accent">4</b>
            repair points. These repairs can be spent from this mechâ€™s own pool or the pools of any
            pilots that wish to contribute, in any combination.
          </div>
        </v-alert>
        <div class="text-subtle mt-2">
          REPAIR CAPACITY REMAINING:
          <b class="text-accent">{{ mech.CurrentRepairs }}</b>
        </div>
        <div>
          <v-icon v-for="n in mech.CurrentRepairs" large>control_point</v-icon>
          <v-icon
            v-for="n in mech.RepairCapacity - mech.CurrentRepairs"
            large
            color="grey darken-1"
          >
            mdi-circle-outline
          </v-icon>
        </div>
        <div class="heading h3 mt-2 text-left">REPAIR POINTS</div>
        <v-slider
          v-model="selfRepair"
          :max="Math.min(mech.CurrentRepairs, 4)"
          step="1"
          thumb-label
          ticks="always"
          tick-size="6"
          track-color="active"
          track-fill-color="success"
        />
        <div class="heading h3 mt-2 text-left">ALLY REPAIR POINTS</div>
        <v-slider
          v-model="allyRepair"
          step="1"
          :max="4 - selfRepair"
          ticks="always"
          thumb-label
          tick-size="6"
          track-color="active"
          track-fill-color="success"
        />
        <v-btn
          tile
          color="success darken-1"
          x-large
          dark
          class="mb-4 mt-n1"
          :disabled="selfRepair + allyRepair < 4"
          @click="pilot.State.RepairDestroyed(selfRepair)"
        >
          <v-icon size="x-large" left>cc:repair</v-icon>
          &nbsp; Repair Mech
        </v-btn>
      </div>
    </div>
    <div v-if="!mech.ReactorDestroyed">
      <v-divider class="my-4" />
      <div class="text-center">
        <cc-active-synergy :locations="['rest']" :mech="mech" />
      </div>
      <span v-if="!mech.Destroyed && !mech.ReactorDestroyed" class="text-overline">
        FIELD REPAIR INTERFACE
        <v-btn small right icon class="fade-select" @click="showRepair = !showRepair">
          <v-icon small v-html="showRepair ? 'mdi-eye-outline' : 'mdi-eye-off-outline'" />
        </v-btn>
      </span>
      <v-container
        v-if="!mech.Destroyed && !mech.ReactorDestroyed && showRepair"
        class="panel clipped mb-6 mt-n1"
      >
        <v-row density="compact" class="px-3">
          <v-col v-if="$vuetify.display.mdAndUp">
            <p class="caption flavor-text text-subtle pb-0 mb-0">
              //[COMP/CON: COMBAT OPERATIONS COMPLETE
              <br />
              DISCONNECTING PILOT SENSORIUM ... done
              <br />
              UPLOADING BATTLEFIELD TELEMETRY ... done
              <br />
              RUNNING FRAME DIAGNOSTIC SUITE ... done ]
              <br />
              <span class="text-overline text-stark">
                {{ mech.Frame.Source }} {{ mech.Frame.Name }} DIAGNOSTICS COMPLETE
              </span>
            </p>
            <p class="flavor-text text-subtle mb-0">
              >//[
              <span class="text-accent">COMP/CON</span>
              <span class="text-text">
                Lancer, I have detected
                <b class="text-accent">{{ issues }}</b>
                issue{{ issues === 1 ? '' : 's' }} requiring your attention:
              </span>
              ]
            </p>
          </v-col>
          <v-col>
            <div class="text-center mb-1">
              <span class="heading h3">
                REPAIR CAPACITY REMAINING:
                <b class="text-accent heading h2">{{ mech.CurrentRepairs }}</b>
              </span>
              <br />
              <span>
                <v-icon v-for="n in mech.CurrentRepairs" large>cc:repair</v-icon>
                <v-icon
                  v-for="n in mech.RepairCapacity - mech.CurrentRepairs"
                  large
                  color="grey"
                  style="opacity: 0.4"
                >
                  mdi-hexagon-outline
                </v-icon>
              </span>
            </div>
            <div>
              <span class="text-overline">
                <cc-slashes />
                {{ mech.Frame.Source }} {{ mech.Frame.Name }} "{{ mech.Name }}"
              </span>
              <v-progress-linear
                class="pa-0 mt-0 mb-2"
                :value="progress"
                color="blue darken-3"
                background-color="red darken-4"
                height="10"
              />
            </div>
          </v-col>
        </v-row>

        <v-row density="compact" class="px-3">
          <v-col class="text-center flavor-text background">
            <span v-if="mech.CurrentHP === mech.MaxHP" class="text-stark">
              > NO DAMAGE DETECTED
            </span>
            <b v-else class="text-warning">WARNING: DAMAGE DETECTED</b>
            <br />
            <v-btn
              v-if="mech.CurrentHP !== mech.MaxHP"
              small
              dark
              tile
              variant="outlined"
              color="secondary"
              :disabled="!mech.CurrentRepairs"
              @click="pilot.State.RepairHP()"
            >
              Repair
              <v-icon end>control_point</v-icon>
            </v-btn>
          </v-col>

          <v-col class="text-center flavor-text background">
            <span v-if="mech.CurrentStructure === mech.MaxStructure" class="text-stark">
              > STRUCTURAL INTEGRITY NOMINAL
            </span>
            <b v-else class="text-error">CRITICAL: STRUCTURE COMPROMISED</b>
            <br />
            <v-btn
              v-if="mech.CurrentStructure !== mech.MaxStructure"
              small
              dark
              tile
              variant="outlined"
              color="secondary"
              :disabled="cheapStruct ? !mech.CurrentRepairs : mech.CurrentRepairs < 2"
              @click="pilot.State.RepairStructure()"
            >
              Repair
              <v-icon end>control_point</v-icon>
              <v-icon v-if="!cheapStruct" right>control_point</v-icon>
            </v-btn>
          </v-col>

          <v-col class="text-center flavor-text background">
            <span v-if="mech.CurrentStress === mech.MaxStress" class="text-stark">
              > REACTOR INTEGRITY NOMINAL
            </span>
            <b v-else class="text-error">CRITICAL: REACTOR COMPROMISED</b>
            <br />
            <v-btn
              v-if="mech.CurrentStress !== mech.MaxStress"
              small
              dark
              tile
              variant="outlined"
              color="secondary"
              :disabled="cheapStress ? !mech.CurrentRepairs : mech.CurrentRepairs < 2"
              @click="pilot.State.RepairStress()"
            >
              Repair
              <v-icon v-if="!cheapStress" right>control_point</v-icon>
              <v-icon end>control_point</v-icon>
            </v-btn>
          </v-col>
        </v-row>

        <v-row class="px-5">
          <v-col class="text-center flavor-text background">
            <span v-if="!destroyedWeapons.length" class="text-stark">> ARMAMENT NOMINAL</span>
            <b v-else class="text-warning">WARNING: ARMAMENT DAMAGED</b>
            <br />
            <v-btn
              v-for="w in destroyedWeapons"
              small
              dark
              tile
              variant="outlined"
              color="secondary"
              class="my-0"
              :disabled="!mech.CurrentRepairs"
              @click="pilot.State.RepairSystem(w)"
            >
              Repair {{ w.Name }}
              <v-icon end>control_point</v-icon>
            </v-btn>
          </v-col>

          <v-col class="text-center flavor-text background">
            <span v-if="!destroyedSystems.length" class="text-stark">> SYSTEMS NOMINAL</span>
            <b v-else class="text-warning">WARNING: SYSTEMS DAMAGED</b>
            <br />
            <v-btn
              v-for="s in destroyedSystems"
              small
              dark
              tile
              variant="outlined"
              class="my-0"
              color="secondary"
              :disabled="!mech.CurrentRepairs"
              @click="pilot.State.RepairSystem(s)"
            >
              Repair {{ s.Name }}
              <v-icon end>control_point</v-icon>
            </v-btn>
          </v-col>
        </v-row>
      </v-container>

      <div class="mt-2">
        <v-row density="compact" align="center" justify="space-between" class="mt-n3 mx-4">
          <v-col cols="auto">
            <cc-tick-bar
              :current="mech.CurrentStructure"
              :max="mech.MaxStructure"
              large
              :number-only="$vuetify.display.smAndDown"
              :no-input="$vuetify.display.smAndDown"
              :show-buttons="$vuetify.display.smAndDown"
              color="structure"
              full-icon="cc:structure"
              @update="mech.CurrentStructure = $event"
            >
              <span class="heading h3">Structure</span>
            </cc-tick-bar>
          </v-col>
          <v-col cols="auto">
            <cc-tick-bar
              :current="mech.CurrentStress"
              :max="mech.MaxStress"
              large
              :number-only="$vuetify.display.smAndDown"
              :no-input="$vuetify.display.smAndDown"
              :show-buttons="$vuetify.display.smAndDown"
              color="stress"
              full-icon="cc:reactor"
              @update="mech.CurrentStress = $event"
            >
              <span class="heading h3">Stress</span>
            </cc-tick-bar>
          </v-col>
          <v-col cols="auto">
            <cc-tick-bar
              :current="mech.CurrentHP"
              :max="mech.MaxHP"
              large
              :number-only="$vuetify.display.smAndDown"
              :no-input="$vuetify.display.smAndDown"
              :show-buttons="$vuetify.display.smAndDown"
              color="hp"
              full-icon="mdi-hexagon"
              max-length="25"
              @update="mech.CurrentHP = $event"
            >
              <span class="heading h3">HP</span>
            </cc-tick-bar>
          </v-col>
          <v-col cols="auto">
            <cc-tick-bar
              :current="mech.CurrentRepairs"
              :max="mech.RepairCapacity"
              large
              :number-only="$vuetify.display.smAndDown"
              :no-input="$vuetify.display.smAndDown"
              :show-buttons="$vuetify.display.smAndDown"
              color="repcap"
              full-icon="cc:repair"
              @update="mech.CurrentRepairs = $event"
            >
              <span v-if="$vuetify.display.mdAndUp" class="heading h3">REPAIR CAPACITY</span>
              <span v-else class="heading h3">REP. CAP.</span>
            </cc-tick-bar>
          </v-col>
        </v-row>
      </div>

      <active-mode-loadout :mech="mech" rest />

      <div v-show="pilot.State.IsMounted">
        <v-divider class="my-5" />
        <div :style="pilot.IsDead || pilot.IsDownAndOut ? 'opacity: 0.5' : ''">
          <span class="text-overline">PILOT LOADOUT</span>
          <cc-pilot-loadout :pilot="pilot" readonly />

          <v-row density="compact">
            <v-col cols="auto">
              <span class="text-overline">SKILL TRIGGERS</span>
            </v-col>
            <v-col cols="12" md="auto" class="ml-auto">
              <v-btn
                x-small
                variant="outlined"
                class="fade-select"
                @click="expandAll(pilot.SkillsController.Skills.length, 'sk_', true)"
              >
                <v-icon small left>mdi-chevron-up</v-icon>
                All
              </v-btn>
              <v-btn
                x-small
                variant="outlined"
                class="fade-select"
                @click="expandAll(pilot.SkillsController.Skills.length, 'sk_', false)"
              >
                <v-icon small left>mdi-chevron-down</v-icon>
                All
              </v-btn>
            </v-col>
          </v-row>
          <v-row density="compact" justify="center">
            <cc-active-card
              v-for="(s, i) in pilot.SkillsController.Skills"
              :ref="`sk_${i}`"
              :cols="$vuetify.display.lgAndUp ? 4 : $vuetify.display.smAndDown ? 12 : 6"
              color="secondary"
              collapsible
              start-closed
              :header="`${s.Skill.Name} (+${s.Bonus})`"
              :content="s.Skill.Detail"
            />
          </v-row>
        </div>

        <span
          v-if="pilot.ReservesController.Reserves || pilot.ReservesController.Organizations"
          class="text-overline"
        >
          RESERVES AND RESOURCES
          <v-btn small right icon class="fade-select" @click="showReserves = !showReserves">
            <v-icon small v-html="showReserves ? 'mdi-eye-outline' : 'mdi-eye-off-outline'" />
          </v-btn>
        </span>
        <v-scroll-y-reverse-transition mode="out-in">
          <v-row
            v-if="
              showReserves &&
              (pilot.ReservesController.Reserves || pilot.ReservesController.Organizations)
            "
            class="mt-n3"
          >
            <cc-reserve-item
              v-for="(r, i) in pilot.ReservesController.Reserves.filter((r) => r.Type !== 'Bonus')"
              :reserve="r"
              @remove="pilot.ReservesController.RemoveReserve(i)"
            />
            <cc-org-item
              v-for="(o, i) in pilot.ReservesController.Organizations"
              :org="o"
              @remove="pilot.ReservesController.RemoveOrganization(i)"
            />
          </v-row>
        </v-scroll-y-reverse-transition>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import ActiveModeLoadout from '../layout/ActiveModeLoadout.vue';

function normalize(current, max): number {
  if (!max) return 1;
  return current / max;
}

export default {
  name: 'active-rest',
  components: { ActiveModeLoadout },
  data: () => ({
    rest: false,
    diagNumber: 0,
    selfRepair: 0,
    allyRepair: 0,
    showRepair: true,
    showReserves: true,
  }),
  computed: {
    mech() {
      return this.pilot.ActiveMech;
    },
    loadout() {
      return this.mech.MechLoadoutController.ActiveLoadout;
    },
    destroyedWeapons() {
      return this.loadout.Weapons.filter((x) => x.Destroyed);
    },
    destroyedSystems() {
      return this.loadout.Systems.filter((x) => x.Destroyed);
    },
    cheapStruct() {
      return this.mech.FeatureController.Bonuses.some((x) => x.ID === 'cheap_struct');
    },
    cheapStress() {
      return this.mech.FeatureController.Bonuses.some((x) => x.ID === 'cheap_stress');
    },
    issues() {
      return (
        (this.mech.CurrentHP === this.mech.MaxHP ? 0 : 1) +
        (this.mech.CurrentStructure === this.mech.MaxStructure ? 0 : 1) +
        (this.mech.CurrentStress === this.mech.MaxStress ? 0 : 1) +
        this.destroyedWeapons.length +
        this.destroyedSystems.length
      );
    },
    progress(): number {
      return (
        ((normalize(this.mech.CurrentHP, this.mech.MaxHP) +
          normalize(
            this.loadout.Weapons.length - this.destroyedWeapons.length,
            this.loadout.Weapons.length
          ) *
            3 +
          normalize(
            this.loadout.Systems.length - this.destroyedSystems.length,
            this.loadout.Systems.length
          ) *
            3 +
          normalize(this.mech.CurrentStructure, this.mech.MaxStructure) * 10 +
          normalize(this.mech.CurrentStress, this.mech.MaxStress) * 8) /
          24) *
        100
      );
    },
  },
  methods: {
    expandAll(len: number, key: string, expand: boolean) {
      for (let i = 0; i < len; i++) {
        const k = key + i;
        this.$refs[k][0].collapsed = expand;
      }
    },
  },
};
</script>
