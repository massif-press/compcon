<template>
  <div class="pt-2">
    <v-row justify="center" align="center">
      <v-col cols="12" md="">
        <action-detail-expander :action="action" />
      </v-col>
      <v-col cols="auto">
        <v-btn
          large
          tile
          block
          dark
          :disabled="used || actionFree"
          :color="action.Color"
          @click="actionCost = !actionCost"
        >
          <v-icon start>{{ action.Icon }}</v-icon>
          {{ action.Name }}
        </v-btn>
        <v-btn
          small
          tile
          block
          dark
          :disabled="actionCost"
          color="action--free"
          @click="actionFree = !actionFree"
        >
          <v-icon start small>cc:free_action</v-icon>
          Free Action
          <cc-tooltip
            inline
            :content="`Special rules or equipment may allow you to ${action.Name} as a Free Action. Using this button will commit the action without spending a ${action.Activation} Action this turn`"
          >
            <v-icon end small variant="plain">mdi-information-outline</v-icon>
          </cc-tooltip>
        </v-btn>
      </v-col>
    </v-row>

    <v-slide-x-reverse-transition>
      <v-row v-if="actionFree || actionCost" justify="center" align="center">
        <v-col lg="auto" md="12" class="mt-n5">
          <v-row
            density="compact"
            class="text-center mb-n3"
            :justify="$vuetify.display.mdAndUp ? 'start' : 'space-around'"
            align="start"
          >
            <v-col cols="auto" :class="$vuetify.display.mdAndUp ? 'mx-8' : ''">
              <div class="text-overline mb-n2">Attack Roll</div>
              <div class="heading text-text" style="font-size: 24pt">
                <v-icon size="x-large" class="mr-n1">mdi-dice-d20-outline</v-icon>
                + {{ mech.AttackBonus }}
              </div>
            </v-col>
            <v-col cols="auto" :class="$vuetify.display.mdAndUp ? 'mx-8' : ''">
              <div class="text-overline mb-n3">vs. Target</div>
              <v-icon size="x-large" v-html="'cc:evasion'" />
              <div class="text-overline font-weight-bold mt-n2" v-html="'Evasion'" />
            </v-col>
          </v-row>
        </v-col>
        <v-col cols="auto" class="ml-auto">
          <v-row
            density="compact"
            :justify="$vuetify.display.mdAndUp ? 'end' : 'space-around'"
            :class="$vuetify.display.mdAndUp ? '' : 'panel'"
          >
            <v-col
              cols="auto"
              :class="$vuetify.display.mdAndUp ? 'ml-auto px-12 mr-n10 panel dual-sliced' : ''"
              style="height: 70px"
            >
              <div class="text-overline pl-1">Accuracy</div>
              <v-text-field
                v-model="accuracy"
                type="number"
                append-icon="cc:accuracy"
                prepend-icon="mdi-minus-circle-outline"
                style="width: 115px"
                class="hide-input-spinners"
                color="accent"
                density="compact"
                hide-details
                @click:append="accuracy += 1"
                @click:prepend="accuracy -= 1"
                @change="accuracy = parseInt($event)"
              />
            </v-col>
            <v-col
              cols="auto"
              :class="$vuetify.display.mdAndUp ? 'ml-auto px-12 mr-n10 panel dual-sliced' : ''"
              style="height: 70px"
            >
              <div class="text-overline pl-1">Difficulty</div>
              <v-text-field
                v-model="difficulty"
                type="number"
                append-icon="cc:difficulty"
                prepend-icon="mdi-minus-circle-outline"
                style="width: 115px"
                class="hide-input-spinners"
                color="accent"
                density="compact"
                hide-details
                @click:append="difficulty += 1"
                @click:prepend="difficulty -= 1"
                @change="difficulty = parseInt($event)"
              />
            </v-col>
            <v-col
              cols="auto"
              :class="$vuetify.display.mdAndUp ? 'ml-auto px-12 panel dual-sliced' : ''"
              style="height: 70px"
            >
              <div class="text-overline pl-1">Melee Attack Roll</div>
              <v-row no-gutters>
                <v-col class="mr-n2 ml-n2">
                  <cc-dice-menu
                    :preset="`1d20+${mech.AttackBonus}`"
                    :preset-accuracy="accuracy - difficulty"
                    title="SKILL CHECK"
                    autoroll
                    @commit="registerAttackRoll($event.total)"
                  />
                </v-col>
                <v-col>
                  <v-text-field
                    v-model="attackRoll"
                    type="number"
                    class="hide-input-spinners ml-n3"
                    style="max-width: 60px; margin-top: -0.5px"
                    color="accent"
                    density="compact"
                    hide-details
                  />
                </v-col>
              </v-row>
            </v-col>
          </v-row>
        </v-col>
      </v-row>
    </v-slide-x-reverse-transition>

    <v-slide-x-reverse-transition>
      <v-row v-if="attackRoll" density="compact" class="mt-n2">
        <v-col md="6" lg="3" xl="2" class="ml-auto">
          <v-btn
            tile
            block
            class="primary"
            :color="`primary ${succeeded ? 'lighten-1' : ''}`"
            :disabled="failed"
            @click="succeeded = select(succeeded)"
          >
            SUCCESS
          </v-btn>
        </v-col>
        <v-col md="6" lg="3" xl="2">
          <v-btn
            tile
            block
            :disabled="succeeded"
            :color="failed ? 'error' : ''"
            @click="failed = select(failed)"
          >
            FAILURE
          </v-btn>
        </v-col>
      </v-row>
    </v-slide-x-reverse-transition>
    <v-slide-x-reverse-transition>
      <v-row v-if="succeeded" no-gutters justify="center" class="mt-2">
        <v-col cols="auto" class="ml-auto" align="end">
          <div class="body-text text-stark text-left">
            <b>Grapple Success</b>
            <ul>
              <li>You and your target are ENGAGED</li>
              <li>
                Neither you nor your target can BOOST or take reactions for the duration of the
                grapple
              </li>
              <li>
                The smaller character becomes IMMOBILIZED but moves when the larger party moves,
                mirroring their movement. If both parties are the same SIZE, either can make
                contested HULL checks at the start of their turn: the winner counts as larger than
                the loser until this contest is repeated.
              </li>
            </ul>
          </div>
        </v-col>
      </v-row>
    </v-slide-x-reverse-transition>
  </div>
</template>

<script lang="ts">
import { DiceRoller } from '@/class';

import ActionDetailExpander from '../../components/_ActionDetailExpander.vue';

export default {
  name: 'grapple-dialog',
  components: { ActionDetailExpander },
  props: {
    used: { type: Boolean },
    mech: {
      type: Object,
      required: true,
    },
    action: {
      type: Object,
      required: true,
    },
  },
  data: () => ({
    accuracy: 0,
    difficulty: 0,
    attackRoll: '',
    succeeded: false,
    failed: false,
    actionCost: false,
    actionFree: false,
  }),
  watch: {
    used: {
      immediate: true,
      deep: true,
      handler: function (newval) {
        if (!newval) this.init();
      },
    },
  },
  methods: {
    select(action) {
      this.$emit('use', this.actionFree);
      return !action;
    },
    registerAttackRoll(roll) {
      Vue.set(this, 'attackRoll', roll);
      Vue.nextTick().then(() => this.$forceUpdate());
    },
    init() {
      this.accuracy = 0;
      this.difficulty = 0;
      this.attackRoll = '';
      this.attackRollString = '';
      this.rollResultString = '';
      this.rollAccuracyResults = '[]';
      this.succeeded = false;
      this.failed = false;
      this.actionCost = false;
      this.actionFree = false;
    },
  },
};
</script>
