<template>
  <div>
    <v-card-text>
      <p
        class="text-center body-text"
        v-html="'Start, run, or improve an organization, business, or other venture.'"
      />
      <v-divider class="mb-2" />
      <v-card>
        <v-tabs v-model="tabs" color="white" background-color="primary" slider-color="white" grow>
          <v-tab>Establish Organization</v-tab>
          <v-tab :disabled="!organizations.length">Improve Organization</v-tab>
          <v-tab-item>
            <v-card flat tile class="ma-3">
              <v-toolbar dark flat tile density="compact" color="action--downtime">
                <v-toolbar-title class="heading h2">New Organization</v-toolbar-title>
              </v-toolbar>
              <v-card-text class="pa-4">
                <v-row density="compact">
                  <v-col cols="4">
                    <v-select
                      v-model="type"
                      label="Organization Type"
                      :items="orgTypes"
                      variant="outlined"
                      density="compact"
                      hide-details
                    />
                  </v-col>
                  <v-col>
                    <v-text-field
                      v-model="name"
                      variant="outlined"
                      density="compact"
                      hide-details
                      label="Organization Name"
                    />
                  </v-col>
                </v-row>
                <v-row density="compact" justify="center">
                  <v-col cols="10">
                    <v-textarea
                      v-model="details"
                      auto-grow
                      rows="1"
                      label="Purpose, goal, and organization details"
                    />
                  </v-col>
                </v-row>
                <div class="heading h2 text-center mb-2">Start with:</div>
                <v-row density="compact" justify="space-around">
                  <v-col cols="5">
                    <cc-tooltip
                      simple
                      inline
                      content="How directly effective your organization is at what it does (a military organization with high efficiency would be good at combat, for example). <br /> Efficiency can be used to perform activities related to your organization’s purpose (science, military, etc). You can use these advantages as <strong>reserves.</strong>"
                    >
                      <v-btn
                        v-if="!start"
                        large
                        block
                        tile
                        color="primary"
                        @click="start = 'efficiency'"
                      >
                        Efficiency
                      </v-btn>
                      <div v-else class="text-center flavor-text">
                        <span class="heading h2">+ {{ start === 'efficiency' ? '2' : '0' }}</span>
                        <br />
                        <span>Organization Efficiency</span>
                      </div>
                    </cc-tooltip>
                  </v-col>

                  <v-col cols="5">
                    <cc-tooltip
                      simple
                      inline
                      content="Influence is your organization’s size, reach, wealth, and reputation.<br>Influence be used to acquire assets, create opportunities, or sway public opinion."
                    >
                      <v-btn
                        v-if="!start"
                        large
                        block
                        tile
                        color="primary"
                        @click="start = 'influence'"
                      >
                        Influence
                      </v-btn>
                      <div v-else class="text-center flavor-text">
                        <span class="heading h2">+ {{ start === 'influence' ? '2' : '0' }}</span>
                        <br />
                        <span>Organization Influence</span>
                      </div>
                    </cc-tooltip>
                  </v-col>
                </v-row>
              </v-card-text>
            </v-card>
          </v-tab-item>
          <v-tab-item>
            <v-card-text>
              <div v-if="!selected" class="mx-3">
                <v-btn
                  v-for="o in organizations"
                  tile
                  block
                  dark
                  class="my-3"
                  color="action--downtime"
                  @click="selected = o"
                >
                  {{ o.Name }}
                </v-btn>
              </div>
              <v-slide-x-transition>
                <div v-if="selected">
                  <v-btn small text @click="selected = {} as Organization">
                    <v-icon start>mdi-chevron-left</v-icon>
                    Select another organization
                  </v-btn>

                  <v-card tile flat>
                    <v-toolbar dark flat density="compact" color="action--downtime">
                      <v-toolbar-title class="heading h2">
                        {{ selected.Name }}
                      </v-toolbar-title>
                    </v-toolbar>
                    <v-card-text class="mx-3">
                      <v-textarea
                        v-model="selected.Description"
                        auto-grow
                        rows="1"
                        label="Purpose, goal, and organization details"
                      />
                      <v-row justify="center">
                        <v-col cols="5">
                          <v-text-field
                            v-model="improveRoll"
                            type="number"
                            label="Organization Management Roll Result"
                            variant="outlined"
                            density="compact"
                            hide-details
                            append-icon="mdi-plus-circle-outline"
                            prepend-icon="mdi-minus-circle-outline"
                            @click:append="improveRoll++"
                            @click:prepend="improveRoll > 1 ? improveRoll-- : ''"
                          />
                        </v-col>
                      </v-row>

                      <v-slide-y-transition>
                        <v-row v-if="improveRoll" density="compact" class="text-center flavor-text">
                          <v-col v-if="improveRoll < 10">
                            <v-row density="compact" justify="center">
                              <v-col cols="auto" class="pr-2">This organization</v-col>
                              <v-col cols="auto" class="mt-n5">
                                <v-radio-group
                                  v-model="badChoice"
                                  row
                                  density="compact"
                                  style="display: inline-block"
                                >
                                  <v-radio label="Folds Immediately" value="fold" color="error" />
                                  <v-radio
                                    :label="`Loses 2 Efficiency (${selected.Efficiency} available) and 2 Influence (${selected.Influence} available)`"
                                    :disabled="
                                      selected.Influence === 0 && selected.Efficiency === 0
                                    "
                                    value="efficiencyInfluence"
                                    color="warning"
                                  />
                                  <v-radio
                                    :label="`Needs to Take Action`"
                                    value="takeAction"
                                    color="warning"
                                  />
                                </v-radio-group>
                              </v-col>
                            </v-row>
                            <v-slide-x-reverse-transition>
                              <div v-show="badChoice === 'takeAction'">
                                <br />
                                <span> The organization takes one of the following actions: </span>
                                <v-btn-toggle v-model="action" mandatory>
                                  <v-btn text large value="Pay Debts">Pay Debts</v-btn>
                                  <v-btn text large value="Prove Worthiness">
                                    Prove Worthiness
                                  </v-btn>
                                  <v-btn text large value="Get Bailed Out">Get Bailed Out</v-btn>
                                  <v-btn text large value="Make an Aggressive Move">
                                    Make an Aggressive Move
                                  </v-btn>
                                </v-btn-toggle>
                              </div>
                            </v-slide-x-reverse-transition>
                          </v-col>
                          <v-col v-else-if="improveRoll <= 20" cols="12">
                            <v-row
                              v-if="selected.Influence === 6 && selected.Efficiency === 6"
                              row
                              wrap
                            >
                              <v-col class="text-center">
                                <span class="heading h3 text-disabled">
                                  Organization is operating at maximum capacity
                                </span>
                              </v-col>
                            </v-row>
                            <v-row v-else>
                              <v-col cols="12" class="text-center">
                                <span class="heading h3">Improve:</span>
                              </v-col>
                              <v-col cols="5">
                                <v-tooltip top>
                                  <div slot="activator">
                                    <v-btn
                                      large
                                      block
                                      color="primary"
                                      :disabled="
                                        selected.Efficiency === 6 || improvement === 'efficiency'
                                      "
                                      @click="improvement = 'efficiency'"
                                    >
                                      Efficiency
                                    </v-btn>
                                    <div>
                                      <span class="heading h3">
                                        +
                                        {{
                                          selected.Efficiency +
                                          (improvement === 'efficiency' ? 2 : 0)
                                        }}
                                        Efficiency
                                      </span>
                                      <br />
                                      <span>Organization Efficiency</span>
                                    </div>
                                  </div>
                                  <span>
                                    How directly effective your organization is at what it does (a
                                    military organization with high efficiency would be good at
                                    combat, for example).
                                    <br />
                                    Efficiency can be used to perform activities related to your
                                    organization’s purpose (science, military, etc). You can use
                                    these advantages as
                                    <strong>reserves.</strong>
                                  </span>
                                </v-tooltip>
                              </v-col>
                              <v-spacer />
                              <v-col cols="5">
                                <v-tooltip top>
                                  <div slot="activator">
                                    <v-btn
                                      large
                                      block
                                      color="primary"
                                      :disabled="
                                        selected.Influence === 6 || improvement === 'influence'
                                      "
                                      @click="improvement = 'influence'"
                                    >
                                      Influence
                                    </v-btn>
                                    <div>
                                      <span class="heading h3">
                                        +
                                        {{
                                          selected.Influence + (improvement === 'influence' ? 2 : 0)
                                        }}
                                        Influence
                                      </span>
                                      <br />
                                      <span>Organization Influence</span>
                                    </div>
                                  </div>
                                  <span>
                                    Influence is your organization’s size, reach, wealth, and
                                    reputation. Influence be used to acquire assets, create
                                    opportunities, or sway public opinion.
                                  </span>
                                </v-tooltip>
                              </v-col>
                            </v-row>
                          </v-col>
                          <v-col v-else cols="12">
                            <span
                              v-if="selected.Influence < 6 && selected.Efficiency < 6"
                              class="heading h3 text-accent"
                            >
                              Organization Influence and Efficiency increased by +2
                            </span>
                            <span v-else-if="selected.Influence < 6" class="heading h3 text-accent">
                              Organization Influence increased by +2
                            </span>
                            <span
                              v-else-if="selected.Efficiency < 6"
                              class="heading h3 text-accent"
                            >
                              Organization Efficiency increased by +2
                            </span>
                            <span v-else class="heading h3 text-disabled">
                              Organization is operating at maximum capacity
                            </span>
                          </v-col>
                        </v-row>
                      </v-slide-y-transition>
                    </v-card-text>
                  </v-card>
                </div>
              </v-slide-x-transition>
            </v-card-text>
          </v-tab-item>
        </v-tabs>
      </v-card>
    </v-card-text>
    <v-divider />
    <v-card-actions>
      <v-btn text @click="close()">cancel</v-btn>
      <v-spacer />
      <v-btn
        large
        tile
        :color="badChoice === 'fold' ? 'error' : 'primary'"
        :disabled="confirmDisabled"
        @click="tabs === 0 ? addOrg() : improveOrg()"
      >
        {{ confirmName() }}
      </v-btn>
    </v-card-actions>
  </div>
</template>

<script lang="ts">
import { OrgType, Organization } from '@/class';
export default {
  name: 'get-organized',
  props: {
    pilot: {
      type: Object,
      required: true,
    },
  },
  data: () => ({
    tabs: 0,
    type: '',
    name: '',
    details: '',
    start: '',
    purpose: '',
    selected: {} as Organization,
    improveRoll: 0,
    badChoice: '',
    action: '',
    improvement: '',
  }),
  computed: {
    orgTypes() {
      return Object.keys(OrgType)
        .map((k) => OrgType[k])
        .sort() as OrgType[];
    },
    organizations() {
      return this.pilot.ReservesController.Organizations;
    },
    confirmDisabled() {
      if (this.tabs === 0) return !this.name || !this.type || !this.start;
      if (this.tabs === 1) {
        if (this.improveRoll < 10) {
          return !(this.badChoice === 'fold' || (this.badChoice && this.action));
        } else if (this.improveRoll < 20) {
          if (this.selected.Efficiency === 6 && this.selected.Influence === 6) return false;
          else return;
          !this.improvement;
        } else {
          return false;
        }
      }
      return false;
    },
  },
  methods: {
    confirmName() {
      if (this.tabs === 0) return 'Establish Organization';
      if (this.tabs === 1) {
        if (this.badChoice === 'fold') return 'Shutter Organization';
        else return 'Update Organization';
      }
    },
    addOrg() {
      const org = new Organization({
        name: this.name,
        purpose: this.purpose,
        efficiency: this.start === 'efficiency' ? 2 : 0,
        influence: this.start === 'influence' ? 2 : 0,
        description: this.details,
        actions: '',
      });
      this.pilot.ReservesController.AddOrganization(org);
      this.close();
    },
    improveOrg() {
      if (this.improveRoll < 10) {
        if (this.badChoice === 'fold') {
          this.pilot.ReservesController.Organizations.splice(
            this.pilot.ReservesController.Organizations.findIndex(
              (x) => x.Name === this.selected.Name
            ),
            1
          );
        } else if (this.badChoice === 'efficiencyInfluence') {
          if (this.selected.Efficiency > 0) this.selected.Efficiency -= 2;
          if (this.selected.Influence > 0) this.selected.Influence -= 2;
          this.selected.Actions = this.action;
        }
      } else if (this.improveRoll < 20) {
        if (this.improvement === 'efficiency') {
          this.selected.Efficiency += 2;
        } else if (this.improvement === 'influence') {
          this.selected.Influence += 2;
        }
      } else {
        this.selected.Efficiency += 2;
        this.selected.Influence += 2;
      }

      this.close();
    },
    close() {
      this.tabs = 0;
      this.type = '';
      this.name = '';
      this.details = '';
      this.start = '';
      this.selected = {} as Organization;
      this.improveRoll = 0;
      this.badChoice = '';
      this.action = '';
      this.improvement = '';
      this.$emit('close');
    },
  },
};
</script>
